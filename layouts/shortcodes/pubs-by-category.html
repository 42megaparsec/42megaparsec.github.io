{{- $pubs := .Site.Data.publications -}}

{{- /* 먼저 카테고리 목록을 만든다 */ -}}
{{- $categories := slice -}}
{{- range $pubs -}}
  {{- if not (in $categories .category) -}}
    {{- $categories = $categories | append .category -}}
  {{- end -}}
{{- end -}}

{{- /* 각 카테고리에 대해: 
      - count  : 논문 개수
      - latest : 가장 최신 연도
      를 계산해서 stats 슬라이스에 담는다 */ -}}
{{- $catStats := slice -}}
{{- range $categories -}}
  {{- $cat := . -}}
  {{- $catPubs := where $pubs "category" $cat -}}
  {{- $count := len $catPubs -}}

  {{- /* 이 카테고리 내에서 가장 최신 연도 찾기 */ -}}
  {{- $latest := 0 -}}
  {{- range $catPubs -}}
    {{- if gt .year $latest -}}
      {{- $latest = .year -}}
    {{- end -}}
  {{- end -}}

  {{- $catStats = $catStats | append (dict "name" $cat "count" $count "latest" $latest) -}}
{{- end -}}

{{- /* 정렬:
      1) latest 기준 내림차순으로 한 번 정렬
      2) count 기준 내림차순으로 다시 정렬
      → count가 1순위, count가 같으면 latest가 큰 게 위로 오도록 의도 */ -}}
{{- $catStats = sort $catStats "latest" "desc" -}}
{{- $catStats = sort $catStats "count" "desc" -}}

{{- /* 이제 정렬된 카테고리 순서대로 출력 */ -}}
{{- range $catStats -}}
  <h2 class="pub-subtitle">{{ .name }}</h2>

  {{- /* 이 카테고리 안의 논문을 연도 내림차순으로 정렬해서 출력 */ -}}
  {{- $catPubs := where $pubs "category" .name -}}
  {{- $catPubs = sort $catPubs "year" "desc" -}}

  {{- range $catPubs -}}
    {{- partial "pub_item_nodomid.html" . -}}
  {{- end -}}
{{- end -}}
